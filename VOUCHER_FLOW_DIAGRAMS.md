# ğŸ”„ Voucher System Flow Diagrams

## Quick Reference for Voucher Lifecycle & Data Flow

---

## 1ï¸âƒ£ Complete Voucher Lifecycle

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    VOUCHER GENERATION                        â”‚
â”‚                                                              â”‚
â”‚  Merchant Dashboard                                          â”‚
â”‚  â””â”€> Select Package (3hours-25ksh)                          â”‚
â”‚  â””â”€> Set Quantity (10 vouchers)                             â”‚
â”‚  â””â”€> Configure Expiry                                        â”‚
â”‚       â”œâ”€ Auto Expire: YES (30 days)                         â”‚
â”‚       â”œâ”€ Time on Purchase: NO                                â”‚
â”‚       â””â”€ Sync to Router: YES                                 â”‚
â”‚  â””â”€> GENERATE                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 DATABASE & MIKROTIK SYNC                     â”‚
â”‚                                                              â”‚
â”‚  For each voucher:                                           â”‚
â”‚  â”œâ”€ Generate unique code: "ABCD1234"                        â”‚
â”‚  â”œâ”€ Generate payment ref: "VCHXYZ123"                       â”‚
â”‚  â”œâ”€ Create MongoDB document (status: 'active')              â”‚
â”‚  â””â”€ Create MikroTik hotspot user                            â”‚
â”‚      â””â”€ POST /rest/ip/hotspot/user                          â”‚
â”‚          {                                                   â”‚
â”‚            name: "ABCD1234",                                 â”‚
â”‚            password: "ABCD1234",                             â”‚
â”‚            profile: "3hours-25ksh",                          â”‚
â”‚            limit-uptime: "3h"                                â”‚
â”‚          }                                                   â”‚
â”‚      â””â”€ Store mikrotikUserId: "*1A2B3C"                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MERCHANT RECEIVES                         â”‚
â”‚                                                              â”‚
â”‚  âœ… Batch Generated Successfully                            â”‚
â”‚  â”œâ”€ Batch ID: BATCH-1698765432                              â”‚
â”‚  â”œâ”€ Total Value: KES 250                                    â”‚
â”‚  â”œâ”€ Commission: KES 50                                       â”‚
â”‚  â””â”€ Download CSV with vouchers                              â”‚
â”‚                                                              â”‚
â”‚  CSV Contains:                                               â”‚
â”‚  Payment Ref | Code     | Package    | Price | Expires      â”‚
â”‚  VCHXYZ123  | ABCD1234 | 3hrs-25ksh | 25    | 2025-11-30   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              CUSTOMER WANTS TO BUY VOUCHER                   â”‚
â”‚                                                              â”‚
â”‚  Customer Portal / Captive Portal                            â”‚
â”‚  â””â”€> Browse Packages                                         â”‚
â”‚      GET /api/captive/packages?routerId=xxx                  â”‚
â”‚  â””â”€> Select "3 Hours - KES 25"                              â”‚
â”‚  â””â”€> Enter Phone: 0712345678                                â”‚
â”‚  â””â”€> Click "Pay with M-Pesa"                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  STK PUSH INITIATED                          â”‚
â”‚                                                              â”‚
â”‚  POST /api/captive/purchase                                  â”‚
â”‚  {                                                           â”‚
â”‚    router_id: "xxx",                                         â”‚
â”‚    package_id: "3hours-25ksh",                               â”‚
â”‚    phone_number: "0712345678",                               â”‚
â”‚    mac_address: "AA:BB:CC:DD:EE:FF"                          â”‚
â”‚  }                                                           â”‚
â”‚                                                              â”‚
â”‚  Backend Flow:                                               â”‚
â”‚  â”œâ”€ Generate unique voucher code                            â”‚
â”‚  â”œâ”€ Normalize phone: 0712345678 â†’ 254712345678              â”‚
â”‚  â”œâ”€ Create pending transaction in DB                        â”‚
â”‚  â””â”€ Call Safaricom STK Push API                             â”‚
â”‚      â””â”€ BillRefNumber: "VCHXYZ123" (payment reference)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               CUSTOMER RECEIVES STK PUSH                     â”‚
â”‚                                                              â”‚
â”‚  ğŸ“± Safaricom Pop-up:                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  â”‚ Enter M-Pesa PIN                  â”‚                      â”‚
â”‚  â”‚                                   â”‚                      â”‚
â”‚  â”‚ Pay KES 25.00 to 174379           â”‚                      â”‚
â”‚  â”‚ Account Ref: VCHXYZ123            â”‚                      â”‚
â”‚  â”‚                                   â”‚                      â”‚
â”‚  â”‚ [  ][  ][  ][  ]                 â”‚                      â”‚
â”‚  â”‚                                   â”‚                      â”‚
â”‚  â”‚ [Cancel]          [OK]            â”‚                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                                                              â”‚
â”‚  Customer enters PIN and confirms                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              M-PESA PROCESSES PAYMENT                        â”‚
â”‚                                                              â”‚
â”‚  Safaricom validates:                                        â”‚
â”‚  â”œâ”€ PIN is correct                                           â”‚
â”‚  â”œâ”€ Account has sufficient funds                             â”‚
â”‚  â””â”€ Transaction is authorized                                â”‚
â”‚                                                              â”‚
â”‚  If successful:                                              â”‚
â”‚  â””â”€> Call Webhook: POST /api/webhooks/mpesa                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               WEBHOOK RECEIVES CONFIRMATION                  â”‚
â”‚                                                              â”‚
â”‚  POST /api/webhooks/mpesa                                    â”‚
â”‚  {                                                           â”‚
â”‚    TransID: "ABC123XYZ",          // M-Pesa transaction ID  â”‚
â”‚    TransAmount: "25.00",                                     â”‚
â”‚    MSISDN: "254712345678",        // Customer phone          â”‚
â”‚    BillRefNumber: "VCHXYZ123",    // Payment reference       â”‚
â”‚    TransTime: "20250131123456"                               â”‚
â”‚  }                                                           â”‚
â”‚                                                              â”‚
â”‚  Webhook Processing:                                         â”‚
â”‚  â”œâ”€ Find voucher by reference: "VCHXYZ123"                  â”‚
â”‚  â”œâ”€ Validate payment amount: 25.00 = 25.00 âœ“               â”‚
â”‚  â”œâ”€ Calculate commission: 25 * 0.20 = 5.00                  â”‚
â”‚  â”œâ”€ Calculate purchase expiry (if enabled)                  â”‚
â”‚  â””â”€ Update voucher document:                                 â”‚
â”‚      {                                                       â”‚
â”‚        status: 'paid',                                       â”‚
â”‚        payment: {                                            â”‚
â”‚          method: 'mpesa',                                    â”‚
â”‚          transactionId: 'ABC123XYZ',                         â”‚
â”‚          phoneNumber: '254712345678',                        â”‚
â”‚          amount: 25,                                         â”‚
â”‚          commission: 5,                                      â”‚
â”‚          paymentDate: new Date()                             â”‚
â”‚        }                                                     â”‚
â”‚      }                                                       â”‚
â”‚  â””â”€ Create transaction record                               â”‚
â”‚  â””â”€ Create audit log                                         â”‚
â”‚  â””â”€ Respond to Safaricom: { ResultCode: 0 }                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              CUSTOMER RECEIVES CONFIRMATION                  â”‚
â”‚                                                              â”‚
â”‚  ğŸ“± SMS from M-Pesa:                                         â”‚
â”‚  "ABC123XYZ Confirmed. You have paid KES 25.00 to           â”‚
â”‚   WIFI SERVICE on 31/10/25 at 12:34 PM"                     â”‚
â”‚                                                              â”‚
â”‚  Customer should now contact merchant for voucher code       â”‚
â”‚  (Merchant shares: ABCD1234)                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              CUSTOMER ACTIVATES VOUCHER                      â”‚
â”‚                                                              â”‚
â”‚  1. Connect to WiFi: "WiFi-Hotspot"                         â”‚
â”‚  2. Browser redirects to captive portal                      â”‚
â”‚  3. Enter credentials:                                       â”‚
â”‚     Username: ABCD1234                                       â”‚
â”‚     Password: ABCD1234                                       â”‚
â”‚  4. Click Login                                              â”‚
â”‚                                                              â”‚
â”‚  MikroTik validates:                                         â”‚
â”‚  â”œâ”€ User exists in /ip/hotspot/user                         â”‚
â”‚  â”œâ”€ Password matches                                         â”‚
â”‚  â”œâ”€ limit-uptime not exceeded                               â”‚
â”‚  â””â”€ Creates active session in /ip/hotspot/active            â”‚
â”‚                                                              â”‚
â”‚  Session starts:                                             â”‚
â”‚  â”œâ”€ Start time: 2025-10-31 12:35:00                         â”‚
â”‚  â”œâ”€ Expected end: 2025-10-31 15:35:00 (3 hours)             â”‚
â”‚  â””â”€ Customer gets internet access                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  CUSTOMER USES INTERNET                      â”‚
â”‚                                                              â”‚
â”‚  MikroTik tracks:                                            â”‚
â”‚  â”œâ”€ Uptime: 2h 45m (still active)                           â”‚
â”‚  â”œâ”€ Data used: 125 MB                                        â”‚
â”‚  â”œâ”€ Session ID: *AB123                                       â”‚
â”‚  â””â”€ Device MAC: AA:BB:CC:DD:EE:FF                           â”‚
â”‚                                                              â”‚
â”‚  Customer browses, streams, downloads...                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               SESSION TIME LIMIT REACHED                     â”‚
â”‚                                                              â”‚
â”‚  After 3 hours:                                              â”‚
â”‚  MikroTik automatically:                                     â”‚
â”‚  â”œâ”€ Disconnects user from hotspot                           â”‚
â”‚  â”œâ”€ Removes from /ip/hotspot/active                         â”‚
â”‚  â””â”€ User can no longer authenticate                          â”‚
â”‚                                                              â”‚
â”‚  Voucher remains in DB for record-keeping                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  CRON JOB CLEANUP                            â”‚
â”‚                                                              â”‚
â”‚  scripts/expire-vouchers.ts runs every 5 minutes             â”‚
â”‚                                                              â”‚
â”‚  Finds expired vouchers:                                     â”‚
â”‚  â”œâ”€ Activation expired (unused after 30 days)               â”‚
â”‚  â”œâ”€ Purchase expired (purchased timer elapsed)               â”‚
â”‚  â””â”€ Usage expired (session time ended)                      â”‚
â”‚                                                              â”‚
â”‚  For each expired voucher:                                   â”‚
â”‚  â”œâ”€ Remove from MikroTik: DELETE /rest/ip/hotspot/user      â”‚
â”‚  â”œâ”€ Update status: 'expired'                                 â”‚
â”‚  â”œâ”€ Set usage.endTime                                        â”‚
â”‚  â””â”€ Create audit log                                         â”‚
â”‚                                                              â”‚
â”‚  Voucher lifecycle complete âœ“                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2ï¸âƒ£ Data Flow: Voucher Creation

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Merchant Click  â”‚
â”‚  "Generate"      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  POST /api/routers/[id]/vouchers/generateâ”‚
â”‚                                          â”‚
â”‚  Body:                                   â”‚
â”‚  {                                       â”‚
â”‚    packageName: "3hours-25ksh",         â”‚
â”‚    quantity: 10,                         â”‚
â”‚    autoExpire: true,                     â”‚
â”‚    expiryDays: 30,                       â”‚
â”‚    syncToRouter: true                    â”‚
â”‚  }                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. Authenticate User               â”‚
â”‚     getServerSession(authOptions)   â”‚
â”‚     â””â”€> userId                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. Validate Input                  â”‚
â”‚     â”œâ”€ routerId is valid ObjectId   â”‚
â”‚     â”œâ”€ quantity: 1-1000              â”‚
â”‚     â”œâ”€ packageName exists on router  â”‚
â”‚     â””â”€ autoExpire + expiryDays valid â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. Get Customer & Router           â”‚
â”‚     customer = findOne({ userId })  â”‚
â”‚     router = findOne({ _id, cust }) â”‚
â”‚     package = router.packages.find()â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. Calculate Commission            â”‚
â”‚     rate = customer.type === 'isp'  â”‚
â”‚            ? 0 : 20                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. Generate Vouchers (Loop quantity times)    â”‚
â”‚                                                â”‚
â”‚     For i = 0 to quantity:                     â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚     â”‚ a. Generate unique code                â”‚ â”‚
â”‚     â”‚    code = "ABCD1234"                   â”‚ â”‚
â”‚     â”‚    (8 chars, no confusing chars)       â”‚ â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚              â–¼                                  â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚     â”‚ b. Generate payment reference          â”‚ â”‚
â”‚     â”‚    ref = "VCHXYZ123"                   â”‚ â”‚
â”‚     â”‚    (max 12 chars for M-Pesa)           â”‚ â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚              â–¼                                  â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚     â”‚ c. Sync to MikroTik (if enabled)       â”‚ â”‚
â”‚     â”‚    POST /rest/ip/hotspot/user          â”‚ â”‚
â”‚     â”‚    {                                   â”‚ â”‚
â”‚     â”‚      name: "ABCD1234",                 â”‚ â”‚
â”‚     â”‚      password: "ABCD1234",             â”‚ â”‚
â”‚     â”‚      profile: "3hours-25ksh",          â”‚ â”‚
â”‚     â”‚      limit-uptime: "3h"                â”‚ â”‚
â”‚     â”‚    }                                   â”‚ â”‚
â”‚     â”‚    response.ret = "*1A2B3C" (MikroTik)â”‚ â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚              â–¼                                  â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚     â”‚ d. Build voucher document              â”‚ â”‚
â”‚     â”‚    {                                   â”‚ â”‚
â”‚     â”‚      reference: "VCHXYZ123",           â”‚ â”‚
â”‚     â”‚      voucherInfo: {                    â”‚ â”‚
â”‚     â”‚        code: "ABCD1234",               â”‚ â”‚
â”‚     â”‚        password: "ABCD1234",           â”‚ â”‚
â”‚     â”‚        price: 25,                      â”‚ â”‚
â”‚     â”‚        duration: 180                   â”‚ â”‚
â”‚     â”‚      },                                â”‚ â”‚
â”‚     â”‚      mikrotikUserId: "*1A2B3C",        â”‚ â”‚
â”‚     â”‚      status: 'active'                  â”‚ â”‚
â”‚     â”‚    }                                   â”‚ â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  6. Insert to Database              â”‚
â”‚     db.vouchers.insertMany([...])   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  7. Update Router Stats             â”‚
â”‚     $inc: { totalUsers: 10 }        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  8. Create Audit Log                â”‚
â”‚     action: 'create'                â”‚
â”‚     resource: 'voucher'             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  9. Return Response                    â”‚
â”‚     {                                  â”‚
â”‚       success: true,                   â”‚
â”‚       batchId: "BATCH-1698765432",     â”‚
â”‚       vouchers: [...],                 â”‚
â”‚       summary: { ... },                â”‚
â”‚       routerSync: {                    â”‚
â”‚         synced: 10,                    â”‚
â”‚         failed: 0                      â”‚
â”‚       }                                â”‚
â”‚     }                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Merchant UI Updates                â”‚
â”‚  âœ… Shows success message            â”‚
â”‚  ğŸ“¥ Download CSV button enabled      â”‚
â”‚  ğŸ“Š Updates voucher list             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3ï¸âƒ£ Data Flow: M-Pesa Payment

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Customer Clicks â”‚
â”‚  "Pay with M-Pesaâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  POST /api/captive/purchase      â”‚
â”‚  {                               â”‚
â”‚    router_id: "xxx",             â”‚
â”‚    package_id: "3hours-25ksh",   â”‚
â”‚    phone_number: "0712345678"    â”‚
â”‚  }                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. Normalize Phone Number       â”‚
â”‚     0712345678 â†’ 254712345678    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. Find Package & Pricing       â”‚
â”‚     router.packages.hotspot.findâ”‚
â”‚     price = 25                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. Create Pending Transaction   â”‚
â”‚     transaction = {              â”‚
â”‚       status: 'pending',         â”‚
â”‚       phone: '254712345678',     â”‚
â”‚       amount: 25                 â”‚
â”‚     }                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. Call Safaricom STK Push API    â”‚
â”‚     POST /stkpush/processrequest   â”‚
â”‚     {                              â”‚
â”‚       PhoneNumber: "254712345678", â”‚
â”‚       Amount: 25,                  â”‚
â”‚       AccountReference: "VCHXYZ", â”‚
â”‚       CallBackURL: "/webhooks/mpesaâ”‚
â”‚     }                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. Safaricom Responds           â”‚
â”‚     {                            â”‚
â”‚       ResponseCode: "0",         â”‚
â”‚       CheckoutRequestID: "...",  â”‚
â”‚       CustomerMessage: "Success" â”‚
â”‚     }                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  6. Return to Customer           â”‚
â”‚     {                            â”‚
â”‚       success: true,             â”‚
â”‚       message: "Check your phone"â”‚
â”‚     }                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ [Customer enters PIN on phone]
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  7. Safaricom Calls Webhook        â”‚
â”‚     POST /api/webhooks/mpesa       â”‚
â”‚     {                              â”‚
â”‚       TransID: "ABC123",           â”‚
â”‚       TransAmount: "25.00",        â”‚
â”‚       MSISDN: "254712345678",      â”‚
â”‚       BillRefNumber: "VCHXYZ123"   â”‚
â”‚     }                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  8. Find Voucher by Reference    â”‚
â”‚     voucher = findOne({          â”‚
â”‚       reference: "VCHXYZ123"     â”‚
â”‚     })                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  9. Validate Amount              â”‚
â”‚     expected: 25.00              â”‚
â”‚     received: 25.00              â”‚
â”‚     âœ“ Match                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  10. Calculate Commission        â”‚
â”‚      25 * 0.20 = 5.00            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  11. Update Voucher              â”‚
â”‚      status: 'paid'              â”‚
â”‚      payment: {                  â”‚
â”‚        method: 'mpesa',          â”‚
â”‚        transactionId: 'ABC123',  â”‚
â”‚        amount: 25,               â”‚
â”‚        commission: 5             â”‚
â”‚      }                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  12. Record Transaction          â”‚
â”‚      transactions.insert({       â”‚
â”‚        type: 'voucher_sale',     â”‚
â”‚        amount: 25,               â”‚
â”‚        commission: 5             â”‚
â”‚      })                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  13. Create Audit Log            â”‚
â”‚      action: 'voucher_purchased' â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  14. Respond to Safaricom        â”‚
â”‚      {                           â”‚
â”‚        ResultCode: 0,            â”‚
â”‚        ResultDesc: "Success"     â”‚
â”‚      }                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Customer Receives SMS           â”‚
â”‚  "Payment Confirmed: KES 25"     â”‚
â”‚  Contact merchant for code       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4ï¸âƒ£ Expiry Timeline Visualization

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Timeline: Voucher with Multiple Expiry Strategies            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Generation            Purchase             Activation         Expiry
    â”‚                    â”‚                     â”‚                â”‚
    â–¼                    â–¼                     â–¼                â–¼

Day 0: GENERATED     Day 5: PAID          Day 5: USED       Day 30: EXPIRED
status: 'active'     status: 'paid'       status: 'used'    status: 'expired'
    â”‚                    â”‚                     â”‚                â”‚
    â”‚                    â”‚                     â”‚                â”‚
    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚          ACTIVATION EXPIRY (30 days)                      â”‚
    â”‚          If not purchased by Day 30 â†’ expired             â”‚
    â”‚                                                           â”‚
    â”‚                    â”‚                     â”‚                â”‚
    â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                â”‚
    â”‚                    â”‚  PURCHASE EXPIRY    â”‚                â”‚
    â”‚                    â”‚  (if timedOnPurchase)               â”‚
    â”‚                    â”‚  purchaseExpiresAt = purchase + 3h   â”‚
    â”‚                                                           â”‚
    â”‚                                          â”‚                â”‚
    â”‚                                          â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚                                          â”‚ USAGE EXPIRY   â”‚
    â”‚                                          â”‚ (3 hours)      â”‚
    â”‚                                          â”‚ expectedEndTimeâ”‚


SCENARIO 1: Normal Purchase & Use
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Day 0:  Generate (status: 'active')
Day 5:  Customer pays (status: 'paid')
Day 5:  Customer activates (status: 'used')
Day 5:  3 hours pass â†’ MikroTik disconnects
Day 5+: Cron marks as 'expired', removes from router


SCENARIO 2: Purchase but Never Activate
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Day 0:  Generate (status: 'active')
Day 5:  Customer pays (status: 'paid')
        purchaseExpiresAt = Day 5 + 3 hours
Day 5+: Customer never logs in
Day 5+: 3 hours pass â†’ Cron expires (purchaseExpiry)


SCENARIO 3: Generated but Never Purchased
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Day 0:  Generate (status: 'active')
        expiresAt = Day 30
Day 1-29: No purchase
Day 30: Cron expires (activationExpiry)


SCENARIO 4: Purchase on Last Day
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Day 0:  Generate (status: 'active')
        expiresAt = Day 30
Day 29: Customer pays (status: 'paid')
Day 29: Customer uses for 3 hours
Day 29: Session expires normally
        (activationExpiry no longer matters)
```

---

## 5ï¸âƒ£ Security Flow: Payment Reference vs Voucher Code

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WHY SEPARATE PAYMENT REFERENCE FROM VOUCHER CODE?         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âŒ INSECURE APPROACH (Don't do this):
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Generate voucher with code: "ABCD1234"
Use same code for M-Pesa BillRefNumber: "ABCD1234"
                    â”‚
                    â–¼
Anyone monitoring M-Pesa transactions can see:
- Transaction ID: ABC123
- Amount: 25
- BillRefNumber: ABCD1234  â† This is the voucher password!
                    â”‚
                    â–¼
Attacker can now use "ABCD1234" to login to hotspot
Customer loses their paid voucher


âœ… SECURE APPROACH (Current implementation):
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Generate voucher:
  - Payment Reference: "VCHXYZ123" (PUBLIC - for payments)
  - Voucher Code: "ABCD1234" (PRIVATE - for authentication)
                    â”‚
                    â–¼
M-Pesa transaction shows:
- Transaction ID: ABC123
- Amount: 25
- BillRefNumber: VCHXYZ123  â† Payment reference only
                    â”‚
                    â–¼
Attacker sees "VCHXYZ123" but this is useless for login
Only customer knows "ABCD1234" (shared by merchant after payment)


SEPARATION OF CONCERNS:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Payment Reference:
â”œâ”€ Public identifier for payment tracking
â”œâ”€ Used in M-Pesa BillRefNumber (max 12 chars)
â”œâ”€ Used in STK Push AccountReference
â”œâ”€ Stored in database for webhook lookup
â””â”€ Safe to display in payment confirmations

Voucher Code:
â”œâ”€ Private password for hotspot authentication
â”œâ”€ Never exposed in payment flow
â”œâ”€ Shared only after payment confirmation
â”œâ”€ Used as MikroTik username/password
â””â”€ Treated as sensitive credential
```

---

## 6ï¸âƒ£ MikroTik Integration Points

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         MIKROTIK HOTSPOT USER MANAGEMENT                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

STEP 1: Create User Profile (One-time setup)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
POST /rest/ip/hotspot/user/profile
{
  name: "3hours-25ksh",
  rate-limit: "1M/2M",
  session-timeout: "none",      // Handled by limit-uptime
  idle-timeout: "5m",
  keepalive-timeout: "2m",
  shared-users: "1"
}
      â”‚
      â–¼
Profile created on router


STEP 2: Create Hotspot User (Voucher Generation)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
POST /rest/ip/hotspot/user
{
  name: "ABCD1234",              // Voucher code
  password: "ABCD1234",
  profile: "3hours-25ksh",
  limit-uptime: "3h",            // âš ï¸ CRITICAL: Controls session duration
  server: "hotspot1",
  comment: "3 Hours - KSh 25 - Generated automatically"
}
      â”‚
      â–¼
Response: { ret: "*1A2B3C" }     // Store this mikrotikUserId
      â”‚
      â–¼
User can now login to hotspot


STEP 3: User Logs In (Customer Activation)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Customer enters:
  Username: ABCD1234
  Password: ABCD1234
      â”‚
      â–¼
MikroTik checks:
  â”œâ”€ User exists in /ip/hotspot/user âœ“
  â”œâ”€ Password matches âœ“
  â”œâ”€ Profile allows connection âœ“
  â””â”€ limit-uptime not exceeded âœ“
      â”‚
      â–¼
Session created in /ip/hotspot/active
{
  ".id": "*AB123",
  user: "ABCD1234",
  address: "10.5.50.100",
  mac-address: "AA:BB:CC:DD:EE:FF",
  uptime: "0s",
  bytes-in: 0,
  bytes-out: 0
}


STEP 4: Session Tracking (During Usage)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
GET /rest/ip/hotspot/active
[{
  ".id": "*AB123",
  user: "ABCD1234",
  uptime: "2h35m",               // Approaching limit
  bytes-in: 52428800,            // 50 MB
  bytes-out: 104857600           // 100 MB
}]


STEP 5: Session End (Time Limit)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
After 3 hours (limit-uptime):
MikroTik automatically:
  â”œâ”€ Disconnects user
  â”œâ”€ Removes from /ip/hotspot/active
  â””â”€ User cannot re-login (uptime exhausted)
      â”‚
      â–¼
Voucher is now fully used


STEP 6: Cleanup (Cron Job)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
scripts/expire-vouchers.ts
      â”‚
      â–¼
GET /rest/ip/hotspot/user?name=ABCD1234
Response: { ".id": "*1A2B3C", ... }
      â”‚
      â–¼
DELETE /rest/ip/hotspot/user/*1A2B3C
      â”‚
      â–¼
User removed from router
Database status: 'expired'
```

---

## 7ï¸âƒ£ Error Handling & Recovery

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              COMMON SCENARIOS & SOLUTIONS                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

SCENARIO 1: MikroTik Sync Fails During Generation
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Problem: Router offline when generating vouchers
Solution:
  â”œâ”€ Voucher still created in database (mikrotikUserId = null)
  â”œâ”€ syncedToRouter = false in response
  â”œâ”€ Merchant can manually sync later via bulk sync
  â””â”€ Voucher works once synced (before customer tries to login)


SCENARIO 2: Webhook Receives Duplicate Payment
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Problem: Safaricom sends same transaction twice
Solution:
  â”œâ”€ Check if voucher.payment.transactionId already set
  â”œâ”€ If duplicate: Log and return success (idempotent)
  â””â”€ Customer not charged twice


SCENARIO 3: Payment Amount Mismatch
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Problem: Customer pays wrong amount (25.00 vs 20.00)
Solution:
  â”œâ”€ Webhook validates: Math.abs(paid - expected) > 0.01
  â”œâ”€ Reject with ResultCode: 1
  â”œâ”€ Log to webhook_logs for investigation
  â””â”€ Manual refund if needed


SCENARIO 4: Customer Loses Voucher Code
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Problem: Customer paid but lost the voucher code
Solution:
  â”œâ”€ Customer provides M-Pesa transaction ID
  â”œâ”€ Merchant searches: payment.transactionId = "ABC123"
  â”œâ”€ Verify customer's phone matches
  â””â”€ Merchant reshares voucher code


SCENARIO 5: Voucher Expired Before Use
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Problem: Customer bought voucher on Day 29, expires Day 30
Solution:
  â”œâ”€ activationExpiry only applies to unpurchased vouchers
  â”œâ”€ Once paid, voucher stays valid (status: 'paid')
  â”œâ”€ Only purchaseExpiry (if enabled) can expire paid vouchers
  â””â”€ Customer support can extend expiry if needed


SCENARIO 6: Router Disconnects During Active Session
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Problem: Router reboots while customer using voucher
Solution:
  â”œâ”€ MikroTik persists user database (limit-uptime remains)
  â”œâ”€ Active sessions lost, but user can re-login
  â”œâ”€ Uptime continues from previous total
  â””â”€ Customer doesn't lose remaining time


SCENARIO 7: Cron Job Fails to Remove User
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Problem: Expiry cron can't connect to router
Solution:
  â”œâ”€ Voucher still marked 'expired' in database
  â”œâ”€ User remains on router (stale)
  â”œâ”€ Next cron run will retry removal
  â””â”€ Manual cleanup via admin panel if persistent
```

---

**Quick Reference Complete!** ğŸ‰

Use `VOUCHER_SYSTEM_MASTER_GUIDE.md` for detailed documentation. Use this file for quick visual
reference of flows and processes.
