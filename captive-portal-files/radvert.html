<!-- radvert.html -->
<html>
<head>
<meta http-equiv="refresh" content="2; url=$(link-orig)">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0" />   
<meta http-equiv="pragma" content="no-cache">
<meta http-equiv="expires" content="-1">
<title>Internet hotspot - Advertisement</title>
<link rel="stylesheet" href="css/style.css">
<script>

    var popup = '';
    function openOrig() {
	if (window.focus) popup.focus();
	location.href = unescape('$(link-orig-esc)');
    }
    function openAd() {
	location.href = unescape('$(link-redirect-esc)');
    }
    function openAdvert() {
	if (window.name != 'hotspot_advert') {
		popup = open('$(link-redirect)', 'hotspot_advert', '');
		setTimeout("openOrig()", 1000);
		return;
	}
	setTimeout("openAd()", 1000);
    }
</script>
<script>
    // Load api.json then fetch visible packages to display a quick offer list while advertising
    async function loadPackagesPreview() {
        try {
            const res = await fetch('/api.json?v=' + Date.now(), { cache: 'no-store' });
            if (!res.ok) return;
            const cfg = await res.json();
            if (!cfg?.router_id || !cfg?.api_endpoint) return;
            const url = cfg.api_endpoint + '/packages?routerId=' + encodeURIComponent(cfg.router_id);
            var box = document.getElementById('pkg-box');
            var list = document.getElementById('pkg-list');
            var loading = document.getElementById('pkg-loading');
            if (loading) { loading.style.display = 'block'; }
            const r = await fetch(url);
            if (!r.ok) return;
            const data = await r.json();
            if (!data?.packages?.length) return;
            if (!list) return;
            list.innerHTML = '';
            data.packages.slice(0, 3).forEach(function (p) {
                var li = document.createElement('li');
                li.textContent = (p.name || p.id) + ' - ' + (p.price != null ? ('KSh ' + p.price) : '');
                list.appendChild(li);
            });
            if (loading) { loading.style.display = 'none'; }
            if (box) {
                box.style.display = 'block';
                box.style.opacity = '0';
                setTimeout(function(){ box.style.transition = 'opacity 250ms'; box.style.opacity = '1'; }, 0);
            }
        } catch (e) { /* ignore */ }
    }
    document.addEventListener('DOMContentLoaded', loadPackagesPreview);
</script>
</head>
<body onLoad="openAdvert()">
    <div class="ie-fixMinHeight">
        <div class="main">
            <div class="wrap">
                <h1>Advertisement</h1>
                <p class="info">If nothing happens, open <a href="$(link-redirect)" target="hotspot_advert">advertisement</a> manually.</p>
                <div id="pkg-box" style="display:none;margin-top:16px">
                    <div id="pkg-loading" class="info" style="display:none;margin-bottom:6px">Loading packagesâ€¦</div>
                    <h3 style="margin-bottom:6px">Popular Packages</h3>
                    <ul id="pkg-list" style="margin:0;padding-left:18px"></ul>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
